#!/bin/env python3
# -*- coding: utf-8 -*-
# @author DDDivano
# encoding=utf-8 vi:ts=4:sw=4:expandtab:ft=python


from dist_tester import Runner

def test_double_mnist():
    """
    测试双卡MNIST 数据并行策略
    """
    expect = {'gpu0': [2.293632984161377, 1.9767096042633057, 0.7754420042037964, 1.4298748970031738, 1.1149537563323975, 1.6743755340576172, 1.8248095512390137, 1.3372069597244263, 2.8061654567718506, 3.353459596633911], 'gpu1': [2.3047142028808594, 2.199230670928955, 1.5559709072113037, 1.7637412548065186, 1.2709981203079224, 1.3852931261062622, 1.1481263637542725, 1.5861194133758545, 1.8935823440551758, 1.5662521123886108]}
    r = Runner(case_file="dist_mnist_GS.py", gpus="0,1", expect=expect)
    r.run()


def test_quadra_mnist():
    """
    4 cards
    """
    expect = {'gpu0': [2.293632984161377, 1.2199138402938843, 0.5723104476928711, 0.8193329572677612, 0.5711821913719177], 'gpu1': [2.3047142028808594, 2.3398818969726562, 2.425792694091797, 2.377664089202881, 2.269115447998047], 'gpu2': [2.2227988243103027, 1.1840097904205322, 1.2597770690917969, 1.5590503215789795, 1.4131157398223877], 'gpu3': [2.285763740539551, 2.3587706089019775, 2.463667631149292, 2.280930519104004, 2.381772518157959]}
    r = Runner(case_file="dist_mnist_GS.py", gpus="0,1,2,3", expect=expect)
    r.run()

@pytest.mark.skip(reason="暂时跳过此测试，不稳定")
def test_hexa_mnist():
    """
    6 cards
    """
    expect = {'gpu0': [2.293632984161377, 1.3518996238708496, 0.7083066701889038, 0.6319794058799744], 'gpu1': [2.3047142028808594, 2.298741579055786, 2.3047430515289307, 2.298513412475586], 'gpu2': [2.2227988243103027, 1.9032132625579834, 2.8234353065490723, 2.872295379638672], 'gpu3': [2.285763740539551, 2.4317550659179688, 2.2915663719177246, 2.302743434906006], 'gpu4': [2.463984489440918, 2.4549593925476074, 2.3943185806274414, 2.4101004600524902], 'gpu5': [2.4113454818725586, 2.3764865398406982, 2.278918743133545, 2.410250186920166]}
    r = Runner(case_file="dist_mnist_GS.py", gpus="0,1,2,3,4,5", expect=expect)
    r.run()
    
@pytest.mark.skip(reason="暂时跳过此测试，不稳定")
def test_octa_mnist():
    """
    8 cards
    """
    expect = {'gpu0': [2.293632984161377, 0.8205295205116272, 3.517510414123535], 'gpu1': [2.3047142028808594, 2.2995688915252686, 2.182119846343994], 'gpu2': [2.2227988243103027, 1.3816113471984863, 3.4489099979400635], 'gpu3': [2.285763740539551, 2.4820191860198975, 2.3483314514160156], 'gpu4': [2.463984489440918, 2.330746650695801, 2.312662124633789], 'gpu5': [2.4113454818725586, 2.328458547592163, 2.289884090423584], 'gpu6': [2.255356788635254, 2.430631637573242, 2.3036890029907227], 'gpu7': [2.3492424488067627, 2.270418405532837, 2.3453733921051025]}
    r = Runner(case_file="dist_mnist_GS.py", gpus="0,1,2,3,4,5,6,7", expect=expect)
    r.run()
