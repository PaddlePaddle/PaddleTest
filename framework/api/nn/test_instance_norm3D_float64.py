#!/bin/env python
# -*- coding: utf-8 -*-
# encoding=utf-8 vi:ts=4:sw=4:expandtab:ft=python
"""
test_instancenorm3D
"""
from apibase import APIBase
import paddle
import pytest
import numpy as np


class TestInstanceNorm3D(APIBase):
    """
    test
    """

    def hook(self):
        """
        implement
        """
        self.types = [np.float64]
        paddle.set_default_dtype("float64")
        # self.debug = True
        # self.static = True
        # enable check grad
        # self.enable_backward = True


obj = TestInstanceNorm3D(paddle.nn.InstanceNorm3D)


@pytest.mark.api_nn_InstanceNorm3D_parameters
def test_instancenorm3D_base():
    """
    num_features=2
    """
    x_data = np.array(
        [
            [
                [
                    [[0.6964692, 0.28613934, 0.22685145], [0.5513148, 0.71946895, 0.42310646]],
                    [[0.9807642, 0.6848297, 0.4809319], [0.39211753, 0.343178, 0.7290497]],
                ],
                [
                    [[0.43857226, 0.0596779, 0.39804426], [0.7379954, 0.18249173, 0.17545176]],
                    [[0.53155136, 0.53182757, 0.63440096], [0.8494318, 0.7244553, 0.6110235]],
                ],
            ],
            [
                [
                    [[0.7224434, 0.32295892, 0.36178866], [0.22826323, 0.29371405, 0.63097614]],
                    [[0.09210494, 0.4337012, 0.43086275], [0.4936851, 0.4258303, 0.31226122]],
                ],
                [
                    [[0.4263513, 0.89338917, 0.94416004], [0.50183666, 0.6239529, 0.11561839]],
                    [[0.31728548, 0.4148262, 0.86630917], [0.25045538, 0.48303425, 0.98555976]],
                ],
            ],
        ]
    )

    res = [
        [
            [
                [[0.71878886, -1.2011799, -1.478593], [0.03959884, 0.8264067, -0.5602989]],
                [[2.0490298, 0.6643267, -0.28972864], [-0.7052988, -0.93429106, 0.8712358]],
            ],
            [
                [[-0.21512905, -1.8132395, -0.3860691], [1.0477855, -1.295232, -1.3249255]],
                [[0.17704062, 0.17820562, 0.61084235], [1.517805, 0.99067587, 0.51224023]],
            ],
        ],
        [
            [
                [[2.0025582, -0.44593707, -0.20794423], [-1.02634, -0.6251829, 1.4419428]],
                [[-1.8608729, 0.23281753, 0.2154204], [0.60046715, 0.18457581, -0.5115047]],
            ],
            [
                [[-0.5088177, 1.1621695, 1.3438196], [-0.2387431, 0.19816947, -1.6205705]],
                [[-0.89903784, -0.5500526, 1.0652815], [-1.1381453, -0.3060151, 1.4919412]],
            ],
        ],
    ]

    obj.base(res=res, num_features=2, data=x_data)


@pytest.mark.api_nn_InstanceNorm3D_parameters
def test_instancenorm3D1():
    """
    num_features=2
    """
    x_data = np.array(
        [
            [
                [
                    [[0.6964692, 0.28613934, 0.22685145], [0.5513148, 0.71946895, 0.42310646]],
                    [[0.9807642, 0.6848297, 0.4809319], [0.39211753, 0.343178, 0.7290497]],
                ],
                [
                    [[0.43857226, 0.0596779, 0.39804426], [0.7379954, 0.18249173, 0.17545176]],
                    [[0.53155136, 0.53182757, 0.63440096], [0.8494318, 0.7244553, 0.6110235]],
                ],
            ],
            [
                [
                    [[0.7224434, 0.32295892, 0.36178866], [0.22826323, 0.29371405, 0.63097614]],
                    [[0.09210494, 0.4337012, 0.43086275], [0.4936851, 0.4258303, 0.31226122]],
                ],
                [
                    [[0.4263513, 0.89338917, 0.94416004], [0.50183666, 0.6239529, 0.11561839]],
                    [[0.31728548, 0.4148262, 0.86630917], [0.25045538, 0.48303425, 0.98555976]],
                ],
            ],
        ]
    )

    res = [
        [
            [
                [[0.71878886, -1.2011799, -1.478593], [0.03959884, 0.8264067, -0.5602989]],
                [[2.0490298, 0.6643267, -0.28972864], [-0.7052988, -0.93429106, 0.8712358]],
            ],
            [
                [[-0.21512905, -1.8132395, -0.3860691], [1.0477855, -1.295232, -1.3249255]],
                [[0.17704062, 0.17820562, 0.61084235], [1.517805, 0.99067587, 0.51224023]],
            ],
        ],
        [
            [
                [[2.0025582, -0.44593707, -0.20794423], [-1.02634, -0.6251829, 1.4419428]],
                [[-1.8608729, 0.23281753, 0.2154204], [0.60046715, 0.18457581, -0.5115047]],
            ],
            [
                [[-0.5088177, 1.1621695, 1.3438196], [-0.2387431, 0.19816947, -1.6205705]],
                [[-0.89903784, -0.5500526, 1.0652815], [-1.1381453, -0.3060151, 1.4919412]],
            ],
        ],
    ]

    obj.run(res=res, num_features=2, data=x_data)


@pytest.mark.api_nn_InstanceNorm3D_parameters
def test_instancenorm3D2():
    """
    num_features=2, epsilon<=1e-03
    """
    x_data = np.array(
        [
            [
                [
                    [[0.6964692, 0.28613934, 0.22685145], [0.5513148, 0.71946895, 0.42310646]],
                    [[0.9807642, 0.6848297, 0.4809319], [0.39211753, 0.343178, 0.7290497]],
                ],
                [
                    [[0.43857226, 0.0596779, 0.39804426], [0.7379954, 0.18249173, 0.17545176]],
                    [[0.53155136, 0.53182757, 0.63440096], [0.8494318, 0.7244553, 0.6110235]],
                ],
            ],
            [
                [
                    [[0.7224434, 0.32295892, 0.36178866], [0.22826323, 0.29371405, 0.63097614]],
                    [[0.09210494, 0.4337012, 0.43086275], [0.4936851, 0.4258303, 0.31226122]],
                ],
                [
                    [[0.4263513, 0.89338917, 0.94416004], [0.50183666, 0.6239529, 0.11561839]],
                    [[0.31728548, 0.4148262, 0.86630917], [0.25045538, 0.48303425, 0.98555976]],
                ],
            ],
        ]
    )

    res = [
        [
            [
                [[0.71878886, -1.2011799, -1.478593], [0.03959884, 0.8264067, -0.5602989]],
                [[2.0490298, 0.6643267, -0.28972864], [-0.7052988, -0.93429106, 0.8712358]],
            ],
            [
                [[-0.21512905, -1.8132395, -0.3860691], [1.0477855, -1.295232, -1.3249255]],
                [[0.17704062, 0.17820562, 0.61084235], [1.517805, 0.99067587, 0.51224023]],
            ],
        ],
        [
            [
                [[2.0025582, -0.44593707, -0.20794423], [-1.02634, -0.6251829, 1.4419428]],
                [[-1.8608729, 0.23281753, 0.2154204], [0.60046715, 0.18457581, -0.5115047]],
            ],
            [
                [[-0.5088177, 1.1621695, 1.3438196], [-0.2387431, 0.19816947, -1.6205705]],
                [[-0.89903784, -0.5500526, 1.0652815], [-1.1381453, -0.3060151, 1.4919412]],
            ],
        ],
    ]

    obj.run(res=res, num_features=2, data=x_data, epsilon=1e-05)


@pytest.mark.api_nn_InstanceNorm3D_parameters
def test_instancenorm3D3():
    """
    num_features=2, epsilon<=1e-03, momentum=0.1
    """
    x_data = np.array(
        [
            [
                [
                    [[0.6964692, 0.28613934, 0.22685145], [0.5513148, 0.71946895, 0.42310646]],
                    [[0.9807642, 0.6848297, 0.4809319], [0.39211753, 0.343178, 0.7290497]],
                ],
                [
                    [[0.43857226, 0.0596779, 0.39804426], [0.7379954, 0.18249173, 0.17545176]],
                    [[0.53155136, 0.53182757, 0.63440096], [0.8494318, 0.7244553, 0.6110235]],
                ],
            ],
            [
                [
                    [[0.7224434, 0.32295892, 0.36178866], [0.22826323, 0.29371405, 0.63097614]],
                    [[0.09210494, 0.4337012, 0.43086275], [0.4936851, 0.4258303, 0.31226122]],
                ],
                [
                    [[0.4263513, 0.89338917, 0.94416004], [0.50183666, 0.6239529, 0.11561839]],
                    [[0.31728548, 0.4148262, 0.86630917], [0.25045538, 0.48303425, 0.98555976]],
                ],
            ],
        ]
    )

    res = [
        [
            [
                [[0.71878886, -1.2011799, -1.478593], [0.03959884, 0.8264067, -0.5602989]],
                [[2.0490298, 0.6643267, -0.28972864], [-0.7052988, -0.93429106, 0.8712358]],
            ],
            [
                [[-0.21512905, -1.8132395, -0.3860691], [1.0477855, -1.295232, -1.3249255]],
                [[0.17704062, 0.17820562, 0.61084235], [1.517805, 0.99067587, 0.51224023]],
            ],
        ],
        [
            [
                [[2.0025582, -0.44593707, -0.20794423], [-1.02634, -0.6251829, 1.4419428]],
                [[-1.8608729, 0.23281753, 0.2154204], [0.60046715, 0.18457581, -0.5115047]],
            ],
            [
                [[-0.5088177, 1.1621695, 1.3438196], [-0.2387431, 0.19816947, -1.6205705]],
                [[-0.89903784, -0.5500526, 1.0652815], [-1.1381453, -0.3060151, 1.4919412]],
            ],
        ],
    ]

    obj.run(res=res, num_features=2, data=x_data, epsilon=1e-05, momentum=0.1)


@pytest.mark.api_nn_InstanceNorm3D_parameters
def test_instancenorm3D4():
    """
    num_features=2, epsilon<=1e-03, momentum=0.9
    """
    x_data = np.array(
        [
            [
                [
                    [[0.6964692, 0.28613934, 0.22685145], [0.5513148, 0.71946895, 0.42310646]],
                    [[0.9807642, 0.6848297, 0.4809319], [0.39211753, 0.343178, 0.7290497]],
                ],
                [
                    [[0.43857226, 0.0596779, 0.39804426], [0.7379954, 0.18249173, 0.17545176]],
                    [[0.53155136, 0.53182757, 0.63440096], [0.8494318, 0.7244553, 0.6110235]],
                ],
            ],
            [
                [
                    [[0.7224434, 0.32295892, 0.36178866], [0.22826323, 0.29371405, 0.63097614]],
                    [[0.09210494, 0.4337012, 0.43086275], [0.4936851, 0.4258303, 0.31226122]],
                ],
                [
                    [[0.4263513, 0.89338917, 0.94416004], [0.50183666, 0.6239529, 0.11561839]],
                    [[0.31728548, 0.4148262, 0.86630917], [0.25045538, 0.48303425, 0.98555976]],
                ],
            ],
        ]
    )

    res = [
        [
            [
                [[0.71878886, -1.2011799, -1.478593], [0.03959884, 0.8264067, -0.5602989]],
                [[2.0490298, 0.6643267, -0.28972864], [-0.7052988, -0.93429106, 0.8712358]],
            ],
            [
                [[-0.21512905, -1.8132395, -0.3860691], [1.0477855, -1.295232, -1.3249255]],
                [[0.17704062, 0.17820562, 0.61084235], [1.517805, 0.99067587, 0.51224023]],
            ],
        ],
        [
            [
                [[2.0025582, -0.44593707, -0.20794423], [-1.02634, -0.6251829, 1.4419428]],
                [[-1.8608729, 0.23281753, 0.2154204], [0.60046715, 0.18457581, -0.5115047]],
            ],
            [
                [[-0.5088177, 1.1621695, 1.3438196], [-0.2387431, 0.19816947, -1.6205705]],
                [[-0.89903784, -0.5500526, 1.0652815], [-1.1381453, -0.3060151, 1.4919412]],
            ],
        ],
    ]

    obj.run(res=res, num_features=2, data=x_data, epsilon=1e-05, momentum=0.9)


@pytest.mark.api_nn_InstanceNorm3D_parameters
def test_instancenorm3D5():
    """
    num_features=2, epsilon<=1e-03, momentum=0.9, weight_attr=False, bias_attr=False
    """
    x_data = np.array(
        [
            [
                [
                    [[0.6964692, 0.28613934, 0.22685145], [0.5513148, 0.71946895, 0.42310646]],
                    [[0.9807642, 0.6848297, 0.4809319], [0.39211753, 0.343178, 0.7290497]],
                ],
                [
                    [[0.43857226, 0.0596779, 0.39804426], [0.7379954, 0.18249173, 0.17545176]],
                    [[0.53155136, 0.53182757, 0.63440096], [0.8494318, 0.7244553, 0.6110235]],
                ],
            ],
            [
                [
                    [[0.7224434, 0.32295892, 0.36178866], [0.22826323, 0.29371405, 0.63097614]],
                    [[0.09210494, 0.4337012, 0.43086275], [0.4936851, 0.4258303, 0.31226122]],
                ],
                [
                    [[0.4263513, 0.89338917, 0.94416004], [0.50183666, 0.6239529, 0.11561839]],
                    [[0.31728548, 0.4148262, 0.86630917], [0.25045538, 0.48303425, 0.98555976]],
                ],
            ],
        ]
    )

    res = [
        [
            [
                [[0.71878886, -1.2011799, -1.478593], [0.03959884, 0.8264067, -0.5602989]],
                [[2.0490298, 0.6643267, -0.28972864], [-0.7052988, -0.93429106, 0.8712358]],
            ],
            [
                [[-0.21512905, -1.8132395, -0.3860691], [1.0477855, -1.295232, -1.3249255]],
                [[0.17704062, 0.17820562, 0.61084235], [1.517805, 0.99067587, 0.51224023]],
            ],
        ],
        [
            [
                [[2.0025582, -0.44593707, -0.20794423], [-1.02634, -0.6251829, 1.4419428]],
                [[-1.8608729, 0.23281753, 0.2154204], [0.60046715, 0.18457581, -0.5115047]],
            ],
            [
                [[-0.5088177, 1.1621695, 1.3438196], [-0.2387431, 0.19816947, -1.6205705]],
                [[-0.89903784, -0.5500526, 1.0652815], [-1.1381453, -0.3060151, 1.4919412]],
            ],
        ],
    ]

    obj.run(res=res, num_features=2, data=x_data, epsilon=1e-05, momentum=0.9, weight_attr=False, bias_attr=False)


@pytest.mark.api_nn_InstanceNorm3D_parameters
def test_instancenorm3D6():
    """
    num_features=2, epsilon<=1e-03, momentum=0.9, data_format='NCDHW'
    """
    x_data = np.array(
        [
            [
                [
                    [[0.6964692, 0.28613934, 0.22685145], [0.5513148, 0.71946895, 0.42310646]],
                    [[0.9807642, 0.6848297, 0.4809319], [0.39211753, 0.343178, 0.7290497]],
                ],
                [
                    [[0.43857226, 0.0596779, 0.39804426], [0.7379954, 0.18249173, 0.17545176]],
                    [[0.53155136, 0.53182757, 0.63440096], [0.8494318, 0.7244553, 0.6110235]],
                ],
            ],
            [
                [
                    [[0.7224434, 0.32295892, 0.36178866], [0.22826323, 0.29371405, 0.63097614]],
                    [[0.09210494, 0.4337012, 0.43086275], [0.4936851, 0.4258303, 0.31226122]],
                ],
                [
                    [[0.4263513, 0.89338917, 0.94416004], [0.50183666, 0.6239529, 0.11561839]],
                    [[0.31728548, 0.4148262, 0.86630917], [0.25045538, 0.48303425, 0.98555976]],
                ],
            ],
        ]
    )

    res = [
        [
            [
                [[0.71878886, -1.2011799, -1.478593], [0.03959884, 0.8264067, -0.5602989]],
                [[2.0490298, 0.6643267, -0.28972864], [-0.7052988, -0.93429106, 0.8712358]],
            ],
            [
                [[-0.21512905, -1.8132395, -0.3860691], [1.0477855, -1.295232, -1.3249255]],
                [[0.17704062, 0.17820562, 0.61084235], [1.517805, 0.99067587, 0.51224023]],
            ],
        ],
        [
            [
                [[2.0025582, -0.44593707, -0.20794423], [-1.02634, -0.6251829, 1.4419428]],
                [[-1.8608729, 0.23281753, 0.2154204], [0.60046715, 0.18457581, -0.5115047]],
            ],
            [
                [[-0.5088177, 1.1621695, 1.3438196], [-0.2387431, 0.19816947, -1.6205705]],
                [[-0.89903784, -0.5500526, 1.0652815], [-1.1381453, -0.3060151, 1.4919412]],
            ],
        ],
    ]

    obj.run(res=res, num_features=2, data=x_data, epsilon=1e-05, momentum=0.9, data_format="NCDHW")
