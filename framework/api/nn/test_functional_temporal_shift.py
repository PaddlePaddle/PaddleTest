#!/usr/bin/env python
# -*- coding: utf-8 -*-
# encoding=utf-8 vi:ts=4:sw=4:expandtab:ft=python

"""
test_temporal_shift
"""

from apibase import APIBase
import paddle
import pytest
import numpy as np


class TestTemporalShift(APIBase):
    """
    test temporal_shift
    """

    def hook(self):
        """
        implement
        """
        self.types = [np.float32, np.float64]
        # self.debug = True
        # enable check grad
        # self.enable_backward = False


obj = TestTemporalShift(paddle.nn.functional.temporal_shift)


@pytest.mark.api_nn_temporal_shift_vartype
def test_temporal_shift_base():
    """
    base
    """
    np.random.seed(22)
    x = np.random.rand(2, 2, 4, 3)
    res = np.array(
        [
            [
                [
                    [0.42755524, 0.58428964, 0.70263552],
                    [0.11189517, 0.92326993, 0.98888627],
                    [0.67741077, 0.79516478, 0.02907635],
                    [0.17775907, 0.87492775, 0.74493208],
                ],
                [
                    [0.81372619, 0.7451003, 0.18911136],
                    [0.00614087, 0.77204387, 0.95783217],
                    [0.70193788, 0.29757827, 0.76799274],
                    [0.68821832, 0.38718348, 0.61520583],
                ],
            ],
            [
                [[0.0, 0.0, 0.0], [0.0, 0.0, 0.0], [0.0, 0.0, 0.0], [0.0, 0.0, 0.0]],
                [
                    [0.50809016, 0.1283339, 0.48428424],
                    [0.51577349, 0.31126466, 0.04566154],
                    [0.43768066, 0.09588461, 0.04521011],
                    [0.68482872, 0.84919075, 0.12520718],
                ],
            ],
        ]
    )
    obj.base(res=res, x=x, seg_num=2)


@pytest.mark.api_nn_temporal_shift_parameters
def test_temporal_shift0():
    """
    default
    """
    np.random.seed(22)
    x = np.random.rand(6, 4, 2, 2)
    res = np.array(
        [
            [
                [[0.0, 0.0], [0.0, 0.0]],
                [[0.76799274, 0.68821832], [0.38718348, 0.61520583]],
                [[0.22040452, 0.81195092], [0.01052687, 0.5612037]],
                [[0.81372619, 0.7451003], [0.18911136, 0.00614087]],
            ],
            [
                [[0.20846054, 0.48168106], [0.42053804, 0.859182]],
                [[0.0, 0.0], [0.0, 0.0]],
                [[0.42755524, 0.58428964], [0.70263552, 0.11189517]],
                [[0.92326993, 0.98888627], [0.67741077, 0.79516478]],
            ],
            [
                [[0.0, 0.0], [0.0, 0.0]],
                [[0.60741386, 0.44350009], [0.98202911, 0.70895541]],
                [[0.31126466, 0.04566154], [0.43768066, 0.09588461]],
                [[0.04521011, 0.68482872], [0.84919075, 0.12520718]],
            ],
            [
                [[0.02907635, 0.17775907], [0.87492775, 0.74493208]],
                [[0.0, 0.0], [0.0, 0.0]],
                [[0.21873042, 0.1674883], [0.53876547, 0.31342079]],
                [[0.911537, 0.08625568], [0.31407403, 0.21913736]],
            ],
            [
                [[0.0, 0.0], [0.0, 0.0]],
                [[0.88649836, 0.25183551], [0.86208781, 0.63519619]],
                [[0.94177639, 0.02304901], [0.673016, 0.16411433]],
                [[0.56813237, 0.24212296], [0.15785591, 0.50356282]],
            ],
            [
                [[0.73666623, 0.82854036], [0.74456446, 0.17753704]],
                [[0.0, 0.0], [0.0, 0.0]],
                [[0.69722318, 0.03045359], [0.6573113, 0.99932242]],
                [[0.50654548, 0.93264575], [0.44080287, 0.20002865]],
            ],
        ]
    )
    obj.run(res=res, x=x, seg_num=2)


@pytest.mark.api_nn_temporal_shift_parameters
def test_temporal_shift1():
    """
    seg_num = 4
    """
    np.random.seed(22)
    x = np.random.rand(4, 4, 3, 3)
    res = np.array(
        [
            [
                [[0.0, 0.0, 0.0], [0.0, 0.0, 0.0], [0.0, 0.0, 0.0]],
                [
                    [0.68482872, 0.84919075, 0.12520718],
                    [0.12906401, 0.47306, 0.19755851],
                    [0.78162275, 0.60741386, 0.44350009],
                ],
                [
                    [0.70193788, 0.29757827, 0.76799274],
                    [0.68821832, 0.38718348, 0.61520583],
                    [0.42755524, 0.58428964, 0.70263552],
                ],
                [
                    [0.11189517, 0.92326993, 0.98888627],
                    [0.67741077, 0.79516478, 0.02907635],
                    [0.17775907, 0.87492775, 0.74493208],
                ],
            ],
            [
                [
                    [0.20846054, 0.48168106, 0.42053804],
                    [0.859182, 0.17116155, 0.33886396],
                    [0.27053283, 0.69104135, 0.22040452],
                ],
                [
                    [0.46995241, 0.50816724, 0.32375161],
                    [0.88649836, 0.25183551, 0.86208781],
                    [0.63519619, 0.69722318, 0.03045359],
                ],
                [
                    [0.98202911, 0.70895541, 0.21873042],
                    [0.1674883, 0.53876547, 0.31342079],
                    [0.911537, 0.08625568, 0.31407403],
                ],
                [
                    [0.21913736, 0.73666623, 0.82854036],
                    [0.74456446, 0.17753704, 0.8584532],
                    [0.00551241, 0.35764317, 0.95314825],
                ],
            ],
            [
                [
                    [0.50809016, 0.1283339, 0.48428424],
                    [0.51577349, 0.31126466, 0.04566154],
                    [0.43768066, 0.09588461, 0.04521011],
                ],
                [
                    [0.66381935, 0.43498705, 0.5146685],
                    [0.56539804, 0.03451502, 0.87238641],
                    [0.35007543, 0.53890134, 0.00740887],
                ],
                [
                    [0.6573113, 0.99932242, 0.50654548],
                    [0.93264575, 0.44080287, 0.20002865],
                    [0.80385357, 0.80767206, 0.05795287],
                ],
                [
                    [0.79030604, 0.45004168, 0.8512108],
                    [0.36241686, 0.20242763, 0.87218944],
                    [0.602708, 0.83185274, 0.02873263],
                ],
            ],
            [
                [
                    [0.94177639, 0.02304901, 0.673016],
                    [0.16411433, 0.56813237, 0.24212296],
                    [0.15785591, 0.50356282, 0.57179515],
                ],
                [[0.0, 0.0, 0.0], [0.0, 0.0, 0.0], [0.0, 0.0, 0.0]],
                [
                    [0.04895547, 0.93330179, 0.21210285],
                    [0.72484069, 0.39805516, 0.73608073],
                    [0.65113767, 0.92503532, 0.61410854],
                ],
                [
                    [0.0370921, 0.11557638, 0.75644423],
                    [0.45177882, 0.60467504, 0.86370606],
                    [0.50038146, 0.81694991, 0.64913881],
                ],
            ],
        ]
    )
    obj.run(res=res, x=x, seg_num=4)


@pytest.mark.api_nn_temporal_shift_parameters
def test_temporal_shift2():
    """
    seg_num = 2
    shift_ratio=0.4
    """
    np.random.seed(22)
    x = np.random.rand(2, 4, 3, 3)
    res = np.array(
        [
            [
                [[0.0, 0.0, 0.0], [0.0, 0.0, 0.0], [0.0, 0.0, 0.0]],
                [
                    [0.68482872, 0.84919075, 0.12520718],
                    [0.12906401, 0.47306, 0.19755851],
                    [0.78162275, 0.60741386, 0.44350009],
                ],
                [
                    [0.98202911, 0.70895541, 0.21873042],
                    [0.1674883, 0.53876547, 0.31342079],
                    [0.911537, 0.08625568, 0.31407403],
                ],
                [
                    [0.11189517, 0.92326993, 0.98888627],
                    [0.67741077, 0.79516478, 0.02907635],
                    [0.17775907, 0.87492775, 0.74493208],
                ],
            ],
            [
                [
                    [0.20846054, 0.48168106, 0.42053804],
                    [0.859182, 0.17116155, 0.33886396],
                    [0.27053283, 0.69104135, 0.22040452],
                ],
                [[0.0, 0.0, 0.0], [0.0, 0.0, 0.0], [0.0, 0.0, 0.0]],
                [[0.0, 0.0, 0.0], [0.0, 0.0, 0.0], [0.0, 0.0, 0.0]],
                [
                    [0.21913736, 0.73666623, 0.82854036],
                    [0.74456446, 0.17753704, 0.8584532],
                    [0.00551241, 0.35764317, 0.95314825],
                ],
            ],
        ]
    )
    obj.run(res=res, x=x, seg_num=2, shift_ratio=0.4)


@pytest.mark.api_nn_temporal_shift_parameters
def test_temporal_shift3():
    """
    seg_num = 2
    shift_ratio=0.4
    """
    np.random.seed(22)
    x = np.random.rand(2, 4, 3, 3)
    res = np.array(
        [
            [
                [[0.0, 0.1283339, 0.42053804], [0.0, 0.31126466, 0.33886396], [0.0, 0.09588461, 0.22040452]],
                [[0.0, 0.84919075, 0.5612037], [0.0, 0.47306, 0.18911136], [0.0, 0.60741386, 0.95783217]],
                [[0.0, 0.70895541, 0.76799274], [0.0, 0.53876547, 0.61520583], [0.0, 0.08625568, 0.70263552]],
                [[0.0, 0.73666623, 0.98888627], [0.0, 0.17753704, 0.02907635], [0.0, 0.35764317, 0.74493208]],
            ],
            [
                [[0.20846054, 0.0, 0.48428424], [0.859182, 0.0, 0.04566154], [0.27053283, 0.0, 0.04521011]],
                [[0.81195092, 0.0, 0.12520718], [0.81372619, 0.0, 0.19755851], [0.00614087, 0.0, 0.44350009]],
                [[0.70193788, 0.0, 0.21873042], [0.68821832, 0.0, 0.31342079], [0.42755524, 0.0, 0.31407403]],
                [[0.11189517, 0.0, 0.82854036], [0.67741077, 0.0, 0.8584532], [0.17775907, 0.0, 0.95314825]],
            ],
        ]
    )
    obj.run(res=res, x=x, seg_num=2, shift_ratio=0.4, data_format="NHWC")
