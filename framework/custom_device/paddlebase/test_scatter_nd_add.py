#!/bin/env python
# -*- coding: utf-8 -*-
# encoding=utf-8 vi:ts=4:sw=4:expandtab:ft=python
"""
test scatter_nd_add
"""
from apibase import APIBase
from apibase import randtool
import paddle
import pytest
import numpy as np


class TestScatterNdAdd(APIBase):
    """
    test scatter_nd_add
    """

    def hook(self):
        """
        implement
        """
        self.types = [np.int32, np.int64, np.float32, np.float64]
        # self.debug = True
        # enable check grad
        self.enable_backward = False
        self.no_grad_var = ["index"]


obj = TestScatterNdAdd(paddle.scatter_nd_add)


@pytest.mark.api_base_scatter_nd_add_vartype
def test_scatter_nd_add_base():
    """
    base
    """
    x = randtool("int", -10, 10, (2, 3, 4))
    index = np.array([[0, 0, 2], [0, 1, 2]])
    updates = np.array([-1, -1])
    res = np.array([[[-3, -8, 7, -1], [-7, -4, 8, 4], [0, 3, -7, -9]], [[3, 2, -3, 2], [1, 6, 6, 0], [-4, 6, -2, 9]]])
    obj.base(res=res, x=x, index=index, updates=updates)


@pytest.mark.api_base_scatter_nd_add_parameters
def test_scatter_nd_add():
    """
    default
    """
    x = randtool("float", -10, 10, (2, 3, 4, 2, 4)).astype(np.float32)
    index = np.array([[0, 0, 1], [0, 1, 1]])
    updates = np.array([[[-1, -1, 1, 2], [1, 1, 2, 1]], [[-1, -1, 1, 2], [1, 1, 2, 1]]]).astype(np.float32)
    res = np.array(
        [
            [
                [
                    [
                        [-6.44531012, -2.72947264, 6.61664486, 5.47986317],
                        [-5.84895039, -4.88733435, -1.5650357, 1.21733248],
                    ],
                    [
                        [-8.60155916, -8.59545851, 9.28046989, 5.24996161],
                        [-2.71562529, 3.6980803, 11.36108208, 4.51371646],
                    ],
                    [
                        [0.484431, -9.10702705, -0.4402568, -7.93553972],
                        [-7.51917887, 8.0391264, -9.68971443, -6.74764585],
                    ],
                    [
                        [4.67472172, -8.48039913, -2.59645629, -7.69525623],
                        [-7.11939812, -0.49134594, 7.93918467, 5.37444544],
                    ],
                ],
                [
                    [
                        [9.82057858, 5.80359983, 8.0485611, 6.43392563],
                        [9.37096119, -6.67953825, -7.3511138, 4.98526335],
                    ],
                    [
                        [1.69545102, 8.36267376, -3.42902994, 1.15514189],
                        [9.08959961, 9.19622993, 2.01448885, 7.99243975],
                    ],
                    [
                        [4.33796644, 9.05742836, -4.14988995, 0.10361318],
                        [7.00586462, 4.51702595, -9.6915617, -9.67443275],
                    ],
                    [
                        [5.13973475, -2.06837487, 5.85701418, 6.51056767],
                        [5.76838255, 9.68992996, -2.11455464, -1.66293705],
                    ],
                ],
                [
                    [
                        [1.29161191, -6.32721567, 0.37328714, -1.50585568],
                        [-6.39245653, -2.34533548, -2.38023424, 9.18538189],
                    ],
                    [
                        [-5.55345201, -8.09437656, 2.29590893, -5.45467472],
                        [3.17838788, -6.58607912, -6.97024012, 4.35105944],
                    ],
                    [
                        [0.60425717, -1.33447146, 7.41676474, 4.56759644],
                        [6.21456957, 6.5432663, -3.6014545, 7.45058203],
                    ],
                    [
                        [-6.83846188, -1.15450108, 9.65893364, -9.38733482],
                        [-5.72535515, 9.57867432, -8.36040592, -8.12208939],
                    ],
                ],
            ],
            [
                [
                    [
                        [0.35049406, -5.61103773, -7.29291153, 7.35865736],
                        [4.18342352, 3.35014057, 6.58528328, 1.35440099],
                    ],
                    [
                        [-4.7195816, -4.7652607, -6.17387247, 2.37246752],
                        [9.87012959, -5.01222229, -3.24064732, 2.96365619],
                    ],
                    [
                        [-0.11490721, -8.22027874, -5.63975334, -1.67902923],
                        [2.2608397, -3.46179962, 8.14625454, 8.34596252],
                    ],
                    [
                        [3.54094839, 1.45326674, -8.67103767, -3.37124228],
                        [-0.44119975, 4.49893665, -8.61887074, 5.40901756],
                    ],
                ],
                [
                    [
                        [-1.56412351, 1.14878118, 7.02062273, 2.28839874],
                        [-7.09865189, 7.32769156, 3.39489055, 3.7851522],
                    ],
                    [[5.1487298, 9.4107523, -2.7213335, 3.47439265], [3.62286949, -6.05781651, 6.81543303, 0.7992565]],
                    [
                        [3.34431624, 3.94278717, -3.65125537, -0.10095018],
                        [9.57347679, 3.02080727, -8.8235693, -9.79538727],
                    ],
                    [
                        [2.36659002, -5.6543746, 8.36274529, 2.58395958],
                        [0.20895053, 5.24749279, -7.42872572, -7.52256489],
                    ],
                ],
                [
                    [
                        [6.82635927, -7.75505686, -3.73306537, 7.13400126],
                        [1.14688444, 4.80876017, -8.21510315, 1.42738378],
                    ],
                    [
                        [0.23492688, -1.70173073, 5.29332304, -2.67730308],
                        [-8.47717762, 1.0936296, 1.52751625, -7.08346224],
                    ],
                    [
                        [-5.09768629, -5.63885069, 0.48839808, -0.2333183],
                        [-4.62592983, 3.24782395, -4.0311594, -1.98022974],
                    ],
                    [
                        [-8.32062912, 9.61007023, 0.18964624, -8.41239834],
                        [-3.74662328, 6.89770412, 4.03875589, 4.0890789],
                    ],
                ],
            ],
        ]
    )
    obj.run(res=res, x=x, index=index, updates=updates)
